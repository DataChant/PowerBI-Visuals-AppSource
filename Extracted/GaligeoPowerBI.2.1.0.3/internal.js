var GaligeoPowerBI;(()=>{var e={25:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{_listeners=new Map;_messages=[];constructor(){}addEventListener(e,t){let s=this._listeners.get(e);s||(s=[],this._listeners.set(e,s)),s.push(t)}removeEventListner(e,t){let s=this._listeners.get(e);return!!s&&(s=s.filter((e=>e!==t)),!0)}fireEvent(e,t){let s=this._listeners.get(e);if(s)for(const e of s)e(t)}}},54:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{static getDataset(e){const t=e.categorical;if(!t)return null;const i={id:"data",name:"PowerBI Data",fields:[],features:[]},o={};t.categories&&s.parseCategory(i,o,t.categories,!0),t.values&&s.parseCategory(i,o,t.values,!1);const a={};for(const e in i.fields){const t=this.getFieldName(i.fields[e].name),s=o[t];for(let e=0;e<s.length;e++)a[e]||(a[e]={}),a[e][t]=s[e]}for(const e in a)i.features.push({attributes:a[e]});return console.log("Nb features",i.features.length),i}static parseCategory(e,t,i,o){if(i)for(let a=0;a<i.length;a++)try{const n=i[a],r=s.getFieldName(n.source.displayName);t[r]=n.values,e.fields.push({name:r,alias:r,alias2:r,type:this.getFieldType(n.source.type),geodim:o})}catch(e){console.error(a,i,e)}}static getFieldName(e){return e.startsWith("Moyenne de ")?e.substring(11):e.startsWith("Somme de ")?e.substring(9):e.startsWith("Sum of ")?e.substring(7):e.startsWith("Average of ")?e.substring(11):e}static getFieldType(e){return e.numeric?"esriFieldTypeDouble":e.integer?"esriFieldTypeInteger":e.bool?"esriFieldTypeBoolean":"esriFieldTypeString"}static hasSameKeys(e,t){return!(!e||!t)&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every((e=>t.hasOwnProperty(e)))}static getFieldKeys(e){const t={};if(void 0===e)return t;for(let s=0;s<e.length;s++)t[e[s].name]=!0;return t}}t.default=s},390:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(25),o=s(716);class a extends i.default{iframe;timeout;ready=!1;responses=new Map;idCounter=1;constructor(e,t=3e4){super(),this.iframe=e,this.timeout=t,this.registerEvents()}registerEvents(){const e=this.iframe;console.log("API - Listen for messages",e.contentWindow),window.addEventListener("message",(t=>{if(t.source!==e.contentWindow)return;if("GaligeoMapLoaded"===t.data)return;const s=new o.Message(t.data);if("response"===s.type){console.log("API- receive response",s);const e=this.responses.get(s.id);e?(console.log("API- resolve response",e),this.responses.delete(s.id),e.resolve(s.value)):console.warn("API- Missing response handler for message ",s)}"event"===s.type&&this.fireEvent(s.source,s)}))}waitMapIsLoad(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{"GaligeoMapLoaded"===t.data&&(this.ready=!0,e("map loaded"))})),setTimeout((()=>{this.ready||t(new Error("Timeout excedeed, failed to load map"))}),this.timeout)}))}postMessage(e,t,s){return new Promise(((i,a)=>{const n=new o.Message;if(n.source="api",n.type="function",n.action=e,n.value=t,n.id=""+this.idCounter++,n.layer=s,!this.ready)throw new Error("Map not ready, unable to send messages");{console.log("API- action =",e,n);const t=new o.Message;if(t.resolve=i,this.responses.set(n.id,t),!this.iframe?.contentWindow)throw new Error("Map iframe not ready, unable to send message "+e);const s=this.iframe.src?new URL(this.iframe.src).origin:"*";this.iframe.contentWindow.postMessage(JSON.stringify(n),s)}}))}}t.default=a},407:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(617),o=s(604),a=s(390),n=s(25);class r extends n.default{refreshId;element;options;iframe;messenger;loaded=!1;constructor(e,t){super(),console.log("Welcome to Galigeo"),this.options=t,this.element="string"==typeof e?document.getElementById(e):e,t.lang||(t.lang=navigator.language.split("-")[0]),t.url||(t.url="https://showroom.galigeo.com/Galigeo"),t.id&&!t.mapId&&(t.mapId=t.id),t.name&&!t.mapId&&(t.mapId=t.name.toUpperCase().toLowerCase().replace(/[^a-z0-9]/gi,"")),this.options.url.endsWith("/")&&(this.options.url=this.options.url.slice(0,-1)),this.options.data||(this.options.data=[]);for(const e of this.options.data)e.url&&(e.url=this.fixRelativeUrl(e.url))}async load(){console.log("Loading Map");try{const e=await(await fetch(this.options.url+"/api/openMap/encoded",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},mode:"cors",body:`status=200&lang=${navigator.language}&data=${encodeURIComponent(JSON.stringify(this.options))}`})).json();if(!e.message)return await this.setMapInstance(e),this;this.showError(e.message,null)}catch(e){throw this.showError("Unable to access Galigeo",e),new Error(e instanceof Error?e.message:String(e))}}async setMapInstance(e){return this.iframe=this.createIframe(this.element,e),this.messenger=new a.default(this.iframe,this.options.timeout),this.refreshId=e.refreshId,this.registerEvents(),await this.messenger.waitMapIsLoad(),console.log("API- Map loaded",e),this.loaded=!0,this.setMapControlsVisible(!1),this}update(e){if(!this.refreshId||!this.loaded)throw new Error("Data update not available");return new Promise(((t,s)=>{fetch(this.options.url+"/api/openMap/encoded?refreshId="+this.refreshId,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:`status=200&lang=${navigator.language}&data=${encodeURIComponent(JSON.stringify(e))}`}).then((e=>e.json().then((e=>{e.message?s(new Error("string"==typeof e.message?e.message:JSON.stringify(e))):t(e)})))).catch((e=>{this.showError("Unable to update data",e),s(new Error(e instanceof Error?e.message:String(e)))}))}))}showError(e,t){console.error("Failed to load map",e,t);const s=this.element;for(;s.firstChild;)s.removeChild(s.firstChild);const i=document.createElement("div");i.id="galigeoError",i.style.height="100%",i.style.textAlign="center",i.style.padding="30px",i.style.backgroundImage="linear-gradient(135deg, #2ecc71 0%, #27a0ad 100%)",i.style.color="white",i.style.fontSize="x-large";const o=document.createElement("h4");o.textContent=`Unable to access Galigeo from ${this.options.url}`,i.appendChild(o);const a=document.createElement("p");a.textContent=e,i.appendChild(a);const n=document.createElement("p");n.textContent=t?t.toLocaleString():"",i.appendChild(n),s.appendChild(i)}isLoaded(){return this.loaded}refresh(){return this.messenger.postMessage("refresh",{})}setExtent(e){return this.messenger.postMessage("setExtent",e)}flyTo(e,t,s){return this.messenger.postMessage("flyTo",{x:e,y:t,zoom:s})}zoomTo(e,t,s){return this.messenger.postMessage("zoomTo",{x:e,y:t,zoom:s})}print(e,t,s){return new Promise(((i,o)=>{this.messenger.postMessage("print",{withLegend:e,savePng:t,title:s}).then((e=>{i(e)}))}))}enableMapNavigation(){return this.messenger.postMessage("enableMapNavigation",{})}disableMapNavigation(){return this.messenger.postMessage("disableMapNavigation",{})}setMenuVisible(e){return this.messenger.postMessage("setMenuVisible",e)}setMapControlsVisible(e){return this.messenger.postMessage("setMapControlsVisible",e)}setOpenNewTabVisible(e){return this.messenger.postMessage("setOpenNewTabVisible",e)}setBasemap(e){return this.messenger.postMessage("setBasemap",e)}addDataUrl(e,t){if(this.isLoaded())throw new Error("Cannot add new data once the map is loaded");this.options.data.push({format:"link",url:this.fixRelativeUrl(e),name:t})}createGeojsonFeatures(e,t){return new Promise(((s,i)=>{this.messenger.postMessage("createGeojsonFeatures",{features:e,style:t}).then((e=>{const t=new o.default(e.layer_id,{name:e.layer_id,isApiLayer:!0,datasetId:void 0,datasourceId:void 0,visible:!0,messenger:this.messenger});s(t)}))}))}addMarker(e,t,s,i){return new Promise(((a,n)=>{this.messenger.postMessage("addMarker",{coordinates:e,style:t,iconSvgOptions:s,urlSvg:i}).then((e=>{const t=new o.default(e.layer_id,{name:e.layer_id,isApiLayer:!0,datasetId:void 0,datasourceId:void 0,visible:!0,messenger:this.messenger});a(t)}))}))}removeLayer(e){return new Promise(((t,s)=>{this.messenger.postMessage("removeLayer",{layer:e}).then((e=>{t(e)}))}))}getLayers(){return new Promise(((e,t)=>{this.messenger.postMessage("getLayers",null).then((t=>{const s=[];for(const e of t){const t=new o.default(e.id,{name:e.name,datasetId:e.datasetId,datasourceId:e.datasourceId,visible:e.visible,messenger:this.messenger});s.push(t)}e(s)}))}))}async getViews(){return await this.messenger.postMessage("getViews",null)}async setView(e){await this.messenger.postMessage("setView",{viewId:e})}registerEvents(){this.messenger.addEventListener("map",(e=>{let t;t="zoomend"===e.action?new i.default(e.value.minX,e.value.minY,e.value.maxX,e.value.maxY):e.value,this.fireEvent(e.action,t)}))}createIframe(e,t){const s=e;let i="index.html";this.options.devMode&&(i="indexdev.jsp"),this.options.viewerGL&&(i="indexgl.html");const o=document.getElementById("galigeoError");o&&o.remove();let a="listenMessages=true";this.options.crossDomain&&(a+="&crossDomain=true"),this.options.parent&&(a+="&parent="+this.options.parent),this.options.lang&&(a+="&lang="+this.options.lang),this.options.listenExternalLinks&&(a+="&listenExternalLinks="+this.options.listenExternalLinks),t.showLoginButton&&(a+="&showLoginButton="+t.showLoginButton);const n=this.options.url+"/"+t.relativeUrlServiceUrl;let r=`${this.options.url}/viewer/${i}?${a}&url=${n}&lang=${navigator.language.split("-")[0]}`;if(t.sso&&this.options.oauth2Enabled&&(r=`${this.options.url}/oauth/login.html?orgId=${t.orgId}&service=${t.service}&redirect=${encodeURIComponent(r)}`,this.options.oauth2Popup&&(r+="&popup=true"),console.log("sso",r)),this.options.redirect)return window.location.href=r,null;let l=e.querySelector("#galigeoMap");if(l)l.src=r;else{for(l=document.createElement("iframe"),l.src=r,l.width="100%",l.height="100%",l.title="Galigeo Map",l.id="galigeoMap",l.setAttribute("style","border: 0px"),l.addEventListener("error",(function(e){console.log("Failed to load iframe : ",e)})),"iPhone"!==navigator.platform&&"iPad"!==navigator.platform||setTimeout((()=>{try{""===l.contentWindow.document.querySelector("body").innerHTML&&(l.focus(),l.src=r)}catch(e){console.log("Failed to load iframe : ",e)}}),2e3);s.firstChild;)s.removeChild(s.firstChild);s.appendChild(l)}return l}fixRelativeUrl(e){if(0!==e.toLowerCase().indexOf("http")){const t=window.location.href.lastIndexOf("/");return window.location.href.substring(0,t+1)+e}return e}}t.default=r},473:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisualFormattingSettingsModel=void 0;const i=s(674);var o=i.formattingSettings.SimpleCard,a=i.formattingSettings.Model;const n=s(959);class r extends o{desc=new i.formattingSettings.ReadOnlyText({name:"desc",displayName:"Product Version",value:n.visual.version});url=new i.formattingSettings.TextInput({name:"url",displayName:"Galigeo URL",placeholder:"https://powerbi.galigeo.com/Galigeo",value:"https://powerbi.galigeo.com/Galigeo"});apiKey=new i.formattingSettings.TextInput({name:"apiKey",displayName:"API Key",placeholder:"Put your API key here",value:"To be completed"});mapId=new i.formattingSettings.TextInput({name:"mapId",displayName:"Identifier of the map",placeholder:"Put the identifier of the map here",value:""});highlight=new i.formattingSettings.ToggleSwitch({name:"highlight",displayName:"Allow map interactions",value:!0});infowindow=new i.formattingSettings.ToggleSwitch({name:"infowindow",displayName:"Display the infowindow",value:!0});name="galigeo";displayName="Galigeo config";slices=[this.desc,this.url,this.apiKey,this.mapId,this.highlight,this.infowindow]}t.VisualFormattingSettingsModel=class extends a{settingCard=new r;cards=[this.settingCard];getGeneralSetting(e){return this.settingCard[e]?.value}}},604:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(25);class o extends i.default{id;name;datasourceId;datasetId;visible;isApiLayer;messenger;constructor(e,t){super(),this.id=e,this.name=t.name?t.name:e,this.datasourceId=t.datasourceId,this.datasetId=t.datasetId,this.visible=t.visible,this.isApiLayer=t.isApiLayer,this.messenger=t.messenger,this.messenger&&this.registerEvents()}getId(){return this.id}getName(){return this.name}getDatasetId(){return this.datasetId}isIssuedFromAPIData(){return this.datasourceId&&"CE"===this.datasourceId}getDatasourceId(){return this.datasourceId}setVisible(e){return this.messenger.postMessage("setVisible",e,this)}disableInfoWindow(){return this.messenger.postMessage("disableInfoWindow","",this)}filter(e){return this.messenger.postMessage("filter",e,this)}registerEvents(){this.messenger.addEventListener("layer",(e=>{e.layer&&e.layer.id===this.id&&this.fireEvent(e.action,e.value)}))}}t.default=o},617:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{xmin;ymin;xmax;ymax;constructor(e,t,s,i){this.xmin=e,this.ymin=t,this.xmax=s,this.ymax=i}}},639:(e,t,s)=>{"use strict";function i(e,t){return{objectName:e,propertyName:t.name,selector:t.selector,altConstantValueSelector:t.altConstantSelector,instanceKind:t.instanceKind}}function o(e,t,s){return null==t||"object"==typeof t&&!t.solid?s:t.solid?{value:null==t?void 0:t.solid.color}:"Dropdown"===(null==e?void 0:e.type)&&e.items?e.items.find((e=>e.value==t)):t}s.d(t,{D:()=>o,y:()=>i})},667:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var i=s(754);const o=class{constructor(e){this.localizationManager=e}populateFormattingSettingsModel(e,t){var s,o;const a=new e,n=null===(s=null==t?void 0:t.metadata)||void 0===s?void 0:s.objects;return n&&(null===(o=a.cards)||void 0===o||o.forEach((e=>{var t;e instanceof i.CompositeCard&&(null===(t=e.topLevelSlice)||void 0===t||t.setPropertiesValues(n,e.name));const s=e instanceof i.SimpleCard?[e]:e.groups;null==s||s.forEach((t=>{var s,i,o,a;null===(s=t.topLevelSlice)||void 0===s||s.setPropertiesValues(n,e.name),null===(i=null==t?void 0:t.slices)||void 0===i||i.forEach((t=>{null==t||t.setPropertiesValues(n,e.name)})),null===(a=null===(o=null==t?void 0:t.container)||void 0===o?void 0:o.containerItems)||void 0===a||a.forEach((t=>{var s;null===(s=null==t?void 0:t.slices)||void 0===s||s.forEach((t=>{null==t||t.setPropertiesValues(n,e.name)}))}))}))}))),a}buildFormattingModel(e){const t={cards:[]};return e.cards.filter((({visible:e=!0})=>e)).forEach((e=>{var s;const o={displayName:this.localizationManager&&e.displayNameKey?this.localizationManager.getDisplayName(e.displayNameKey):e.displayName,description:this.localizationManager&&e.descriptionKey?this.localizationManager.getDisplayName(e.descriptionKey):e.description,groups:[],uid:e.name+"-card",analyticsPane:e.analyticsPane},a=e.name;if(e.topLevelSlice){const t=e.topLevelSlice.getFormattingSlice(a,this.localizationManager);t.suppressDisplayName=!0,o.topLevelToggle=t}null===(s=e.onPreProcess)||void 0===s||s.call(e);const n=e instanceof i.SimpleCard,r=n?[e].filter((({visible:e=!0})=>e)):e.groups.filter((({visible:e=!0})=>e));null==r||r.forEach((e=>{const t=e.name+"-group",s={displayName:n?void 0:this.localizationManager&&e.displayNameKey?this.localizationManager.getDisplayName(e.displayNameKey):e.displayName,description:n?void 0:this.localizationManager&&e.descriptionKey?this.localizationManager.getDisplayName(e.descriptionKey):e.description,slices:[],uid:t,collapsible:e.collapsible,delaySaveSlices:e.delaySaveSlices,disabled:e.disabled,disabledReason:e.disabledReason};o.groups.push(s);const i={};if(e.container){const o=e.container,n=t+"-container",r={displayName:this.localizationManager&&o.displayNameKey?this.localizationManager.getDisplayName(o.displayNameKey):o.displayName,description:this.localizationManager&&o.descriptionKey?this.localizationManager.getDisplayName(o.descriptionKey):o.description,containerItems:[],uid:n};o.containerItems.forEach((e=>{if(!e)return;const t=e.displayNameKey?e.displayNameKey:e.displayName,s=n+t,o={displayName:this.localizationManager&&e.displayNameKey?this.localizationManager.getDisplayName(e.displayNameKey):e.displayName,slices:[],uid:s};this.buildFormattingSlices({slices:e.slices,objectName:a,sliceNames:i,formattingSlices:o.slices}),r.containerItems.push(o)})),s.container=r}if(e.slices){if(e.topLevelSlice){const t=e.topLevelSlice.getFormattingSlice(a,this.localizationManager);t.suppressDisplayName=!0,(null==s.displayName?o:s).topLevelToggle=t}this.buildFormattingSlices({slices:e.slices,objectName:a,sliceNames:i,formattingSlices:s.slices})}})),o.revertToDefaultDescriptors=this.getRevertToDefaultDescriptor(e),t.cards.push(o)})),t}buildFormattingSlices({slices:e,objectName:t,sliceNames:s,formattingSlices:i}){null==e||e.filter((({visible:e=!0})=>e)).forEach((e=>{const o=null==e?void 0:e.getFormattingSlice(t,this.localizationManager);o&&(void 0===s[e.name]?s[e.name]=0:(s[e.name]++,o.uid=`${o.uid}-${s[e.name]}`),i.push(o))}))}getRevertToDefaultDescriptor(e){var t;const s={},o=[];let a,n=[];e instanceof i.CompositeCard&&e.topLevelSlice&&o.push(...null===(t=e.topLevelSlice)||void 0===t?void 0:t.getRevertToDefaultDescriptor(e.name));const r=e instanceof i.SimpleCard?[e].filter((({visible:e=!0})=>e)):e.groups.filter((({visible:e=!0})=>e));return null==r||r.forEach((t=>{var i,r;a=this.getSlicesRevertToDefaultDescriptor(e.name,t.slices,s,t.topLevelSlice),null===(r=null===(i=t.container)||void 0===i?void 0:i.containerItems)||void 0===r||r.forEach((t=>{n=n.concat(this.getSlicesRevertToDefaultDescriptor(e.name,t.slices,s))})),o.push(...a.concat(n))})),o}getSlicesRevertToDefaultDescriptor(e,t,s,i){let o=[];return i&&(s[i.name]=!0,o=o.concat(i.getRevertToDefaultDescriptor(e))),null==t||t.forEach((t=>{t&&!s[t.name]&&(s[t.name]=!0,o=o.concat(t.getRevertToDefaultDescriptor(e)))})),o}}},674:(e,t,s)=>{"use strict";s.r(t),s.d(t,{FormattingSettingsService:()=>o.A,formattingSettings:()=>i,formattingSettingsInterfaces:()=>a});var i=s(754),o=s(667),a=s(954)},716:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Message=t.Style=t.MapParameters=void 0;const i=s(604);t.MapParameters=class{id;mapId;name;lang;url;devMode;crossDomain;parent;skipAutoCreateLayer;data;profile;user;genericAuthentication={editMode:!1};apiKey;redirect;oauth2Enabled;oauth2Popup;timeout;encodeFields=!0;listenExternalLinks;viewerGL},t.Style=class{fillColor;color;fillOpacity;radius;weight},t.Message=class{constructor(e){if(e)try{const t=JSON.parse(e);this.id=t.id,this.source=t.source,this.type=t.type,this.action=t.action,this.value=t.value,t.layer&&(this.layer=new i.default(t.layer.id,{name:t.layer.name}))}catch(t){console.debug("Skip message",e,t)}}source;type;action;value;layer;id;resolve}},754:(e,t,s)=>{"use strict";s.r(t),s.d(t,{AlignmentGroup:()=>p,AutoDropdown:()=>v,AutoFlagsSelection:()=>C,CardGroupEntity:()=>a,ColorPicker:()=>u,CompositeCard:()=>r,CompositeSlice:()=>T,Container:()=>V,ContainerItem:()=>R,DatePicker:()=>y,DurationPicker:()=>w,ErrorRangeControl:()=>b,FieldPicker:()=>M,FontControl:()=>j,FontPicker:()=>D,GradientBar:()=>P,Group:()=>l,ImageUpload:()=>N,ItemDropdown:()=>f,ItemFlagsSelection:()=>S,ListEditor:()=>F,MarginPadding:()=>L,Model:()=>n,NumUpDown:()=>m,ReadOnlyText:()=>E,ShapeMapSelector:()=>O,SimpleCard:()=>c,SimpleSlice:()=>d,Slider:()=>h,TextArea:()=>x,TextInput:()=>I,ToggleSwitch:()=>g});var i=s(639);class o{}class a extends o{}class n{}class r extends o{}class l extends a{constructor(e){super(),Object.assign(this,e)}}class c extends a{}class d extends o{constructor(e){super(),Object.assign(this,e)}getFormattingSlice(e,t){const s=this.type,i=this.name,o={displayName:t&&this.displayNameKey?t.getDisplayName(this.displayNameKey):this.displayName,description:t&&this.descriptionKey?t.getDisplayName(this.descriptionKey):this.description,uid:e+"-"+i};return Object.assign(Object.assign({},o),{control:{type:s,properties:this.getFormattingComponent(e,t)}})}getFormattingComponent(e,t){let s=this.value;return(null==s?void 0:s.displayNameKey)&&(s={displayName:null==t?void 0:t.getDisplayName(s.displayNameKey),value:s.value}),{descriptor:i.y(e,this),value:s}}getRevertToDefaultDescriptor(e){return[{objectName:e,propertyName:this.name}]}setPropertiesValues(e,t){var s;const o=null===(s=null==e?void 0:e[t])||void 0===s?void 0:s[this.name];this.value=i.D(this,o,this.value)}}class p extends d{constructor(e){super(e),this.type="AlignmentGroup"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{mode:this.mode,supportsNoSelection:this.supportsNoSelection})}}class g extends d{constructor(e){super(e),this.type="ToggleSwitch"}}class u extends d{constructor(e){super(e),this.type="ColorPicker"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{defaultColor:this.defaultColor,isNoFillItemSupported:this.isNoFillItemSupported})}}class m extends d{constructor(e){super(e),this.type="NumUpDown"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{options:this.options})}}class h extends m{constructor(){super(...arguments),this.type="Slider"}}class y extends d{constructor(e){super(e),this.type="DatePicker"}getFormattingComponent(e,t){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{placeholder:t&&this.placeholderKey?t.getDisplayName(this.placeholderKey):this.placeholder,validators:this.validators})}}class f extends d{constructor(e){super(e),this.type="Dropdown"}getFormattingComponent(e,t){return Object.assign(Object.assign({},super.getFormattingComponent(e,t)),{items:this.getFormattingItems(t,this.items)})}getFormattingItems(e,t){return t.map((t=>Object.assign(Object.assign({},t),{displayName:e&&t.displayNameKey?e.getDisplayName(t.displayNameKey):t.displayName})))}setValue(e,t){const s=this.getFormattingItems(t,this.items).find((t=>t.value===e));this.value=s||this.items[0]}}class v extends d{constructor(e){super(e),this.type="Dropdown"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{mergeValues:this.mergeValues,filterValues:this.filterValues})}}class w extends d{constructor(e){super(e),this.type="DurationPicker"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{validators:this.validators})}}class b extends d{constructor(e){super(e),this.type="ErrorRangeControl"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{validators:this.validators})}}class M extends d{constructor(e){super(e),this.type="FieldPicker"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{validators:this.validators,allowMultipleValues:this.allowMultipleValues})}}class S extends d{constructor(e){super(e),this.type="FlagsSelection"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{items:this.items})}}class C extends d{constructor(){super(...arguments),this.type="FlagsSelection"}}class I extends d{constructor(e){super(e),this.type="TextInput"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{placeholder:this.placeholder})}}class x extends I{constructor(){super(...arguments),this.type="TextArea"}}class D extends d{constructor(){super(...arguments),this.type="FontPicker"}}class P extends d{constructor(){super(...arguments),this.type="GradientBar"}}class N extends d{constructor(){super(...arguments),this.type="ImageUpload"}}class F extends d{constructor(){super(...arguments),this.type="ListEditor"}}class E extends d{constructor(){super(...arguments),this.type="ReadOnlyText"}}class O extends d{constructor(e){super(e),this.type="ShapeMapSelector"}getFormattingComponent(e){return Object.assign(Object.assign({},super.getFormattingComponent(e)),{isAzMapReferenceSelector:this.isAzMapReferenceSelector})}}class T extends o{constructor(e){super(),Object.assign(this,e)}getFormattingSlice(e,t){const s=this.type,i=this.name,o={displayName:t&&this.displayNameKey?t.getDisplayName(this.displayNameKey):this.displayName,description:t&&this.descriptionKey?t.getDisplayName(this.descriptionKey):this.description,uid:e+"-"+i};return Object.assign(Object.assign({},o),{control:{type:s,properties:this.getFormattingComponent(e)}})}}class j extends T{constructor(e){super(e),this.type="FontControl"}getFormattingComponent(e){var t,s,i;return{fontFamily:this.fontFamily.getFormattingComponent(e),fontSize:this.fontSize.getFormattingComponent(e),bold:null===(t=this.bold)||void 0===t?void 0:t.getFormattingComponent(e),italic:null===(s=this.italic)||void 0===s?void 0:s.getFormattingComponent(e),underline:null===(i=this.underline)||void 0===i?void 0:i.getFormattingComponent(e)}}getRevertToDefaultDescriptor(e){return this.fontFamily.getRevertToDefaultDescriptor(e).concat(this.fontSize.getRevertToDefaultDescriptor(e)).concat(this.bold?this.bold.getRevertToDefaultDescriptor(e):[]).concat(this.italic?this.italic.getRevertToDefaultDescriptor(e):[]).concat(this.underline?this.underline.getRevertToDefaultDescriptor(e):[])}setPropertiesValues(e,t){var s,i,o;this.fontFamily.setPropertiesValues(e,t),this.fontSize.setPropertiesValues(e,t),null===(s=this.bold)||void 0===s||s.setPropertiesValues(e,t),null===(i=this.italic)||void 0===i||i.setPropertiesValues(e,t),null===(o=this.underline)||void 0===o||o.setPropertiesValues(e,t)}}class L extends T{constructor(e){super(e),this.type="MarginPadding"}getFormattingComponent(e){return{left:this.left.getFormattingComponent(e),right:this.right.getFormattingComponent(e),top:this.top.getFormattingComponent(e),bottom:this.bottom.getFormattingComponent(e)}}getRevertToDefaultDescriptor(e){return this.left.getRevertToDefaultDescriptor(e).concat(this.right.getRevertToDefaultDescriptor(e)).concat(this.top.getRevertToDefaultDescriptor(e)).concat(this.bottom.getRevertToDefaultDescriptor(e))}setPropertiesValues(e,t){this.left.setPropertiesValues(e,t),this.right.setPropertiesValues(e,t),this.top.setPropertiesValues(e,t),this.bottom.setPropertiesValues(e,t)}}class V extends o{constructor(e){super(),Object.assign(this,e)}}class R extends o{}},793:(e,t,s)=>{"use strict";s.r(t)},848:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Visual=void 0;const i=s(674);s(793);const o=s(473),a=s(901),n=s(54),r=s(938),l=s(903);t.Visual=class{textNode;formattingSettings;formattingSettingsService;settings;element;selectionManager;visualConstructorOptions;dataPoints={};listenersRegistered=!1;previousOpenMapData;previousSettings={};previoudFieldsMap={};previousState="";map;onDuplicateMap=!1;constructor(e){console.log("Visual constructor",e),this.formattingSettingsService=new i.FormattingSettingsService,document&&(console.log("Visual constructor",e),this.visualConstructorOptions=e,this.element=e.element,this.showWelcomePage(e.element),this.selectionManager=this.visualConstructorOptions.host.createSelectionManager(),this.selectionManager.clear()),window.addEventListener("message",(async e=>{e?.data?.openUrl&&this.visualConstructorOptions.host.launchUrl(e.data.openUrl)}))}getMapId(){let e=this.settings.getGeneralSetting("mapId");if(!e||e.length<3){e="map"+Date.now().toString(),console.log("Generate mapId",e);const t={objectName:"galigeo",selector:void 0,properties:{mapId:e}};this.visualConstructorOptions.host.persistProperties({merge:[t]})}return e.replace(/[^a-z0-9]/gi,"")}update(e){if(4!==e.type){if(this.onDuplicateMap=!1,this.formattingSettings=this.formattingSettingsService.populateFormattingSettingsModel(o.VisualFormattingSettingsModel,e.dataViews[0]),this.settings=this.formattingSettings,console.log("Visual update",e),console.log("Visual update",e,this.settings,this.settings.getGeneralSetting("mapId")),"to be completed"===this.settings.getGeneralSetting("apiKey").toLowerCase()||this.settings.getGeneralSetting("apiKey").length<3){if("missingApiKey"===this.previousState)return;return this.previousState="missingApiKey",void this.showWelcomePage(this.element,"missingApiKey")}r.Security.authenticate(this.visualConstructorOptions.host,e).then((async t=>{this.loadMap(t,e)}))}}async loadMap(e,t){const s=new Array;for(const e of t.dataViews){const t=e;s.push(n.default.getDataset(t))}const i=new a.MapParameters;i.name=this.settings.getGeneralSetting("mapId"),i.mapId=this.getMapId(),e.authenticated?(i.user=e.user,i.genericAuthentication=void 0):i.genericAuthentication={editMode:e.editMode},console.log("Open map data",i),i.data=s,i.apiKey=this.settings.getGeneralSetting("apiKey"),i.url=this.settings.getGeneralSetting("url"),i.crossDomain=!0,i.listenExternalLinks=!0,i.parent="PowerBI";let o=this.previousOpenMapData&&(this.previousOpenMapData.apiKey!==i.apiKey||this.previousOpenMapData.profile!==i.profile||this.previousOpenMapData.url!==i.url||this.settings.getGeneralSetting("highlight")!==this.previousSettings?.highlight||this.settings.getGeneralSetting("infowindow")!==this.previousSettings?.infowindow||"ok"!==this.previousState);this.previousOpenMapData&&this.previousOpenMapData.mapId!==i.mapId&&this.map?.refreshId&&await this.handleMapDuplication(i,t),this.previousState="ok",n.default.hasSameKeys(this.previoudFieldsMap,n.default.getFieldKeys(s[0].fields))||(o=!0),this.previousOpenMapData=i,this.previousSettings.highlight=this.settings.getGeneralSetting("highlight"),this.previousSettings.infowindow=this.settings.getGeneralSetting("infowindow"),this.previoudFieldsMap=n.default.getFieldKeys(s[0].fields);const r=document.getElementById("galigeoWelcome");r&&(r.style.display="none"),this.onDuplicateMap||(this.map?.refreshId&&!o?this.map.update(i).then((()=>{this.registerMap2Report(t),this.map.refresh()})):(this.map=new a.Map(this.element.id,i),await this.map.load(),this.listenersRegistered=!1,this.registerMap2Report(t)))}async handleMapDuplication(e,t){this.onDuplicateMap=!0;const s=new l.Duplicate(this.element),i=await s.createDuplicateModal(e,t);i&&(e.mapId=i,this.map=new a.Map(this.element.id,e)),await this.map.load(),this.listenersRegistered=!1,this.registerMap2Report(t)}registerMap2Report(e){const t=this.setupFilter(e);this.settings.getGeneralSetting("highlight")&&!this.listenersRegistered&&(this.listenersRegistered=!0,this.map.addEventListener("contextmenu",(e=>{console.log("Context menu on ",e),this.selectionManager.showContextMenu({},{x:e.x,y:e.y})})),this.listenersRegistered=!0,this.map.getLayers().then((e=>{for(const s of e)s.isIssuedFromAPIData()&&(console.log(`Listen interactions from layer ${s.getName()}`),this.settings.getGeneralSetting("infowindow")||s.disableInfoWindow(),s.addEventListener("click",(e=>{const s=[],i={};for(const o of Object.keys(e)){const a=e[o];if(!a?.properties)return;let n=a.properties[t];if(void 0===n&&(n=a.properties[t.toLowerCase().replace(/\s/g,"")]),n&&!i[n]){const e=this.dataPoints[n];s.push(...e),i[n]=1}}console.log("Click on "+Object.keys(e).length+" entities of "+t+". "+s.length+" objects will be selected."),this.selectionManager.select(s),console.log("Selection done"),this.showClearSelectionButton(this.element)})))})))}setupFilter(e){if(!e.dataViews||0===e.dataViews.length)return"Error";const t=e.dataViews[0]?.categorical.categories;if(!t||0===t.length)return console.warn("No categories found in data view"),this.showWelcomePage(this.element,"missingCategory"),"Error";const s=t[0],i=s.values.length;this.dataPoints={};for(let e=0;e<i;e++){const t=s.values[e],i=this.visualConstructorOptions.host.createSelectionIdBuilder().withCategory(s,e).createSelectionId(),o=this.dataPoints[t+""];o?o.push(i):this.dataPoints[t+""]=[i]}return t[0].source.displayName}showClearSelectionButton(e){const t=document.getElementById("ggo-clear-selection");if(t)t.style.display="block";else{const t=document.createElement("button");t.value="clear",t.innerText=navigator.language.indexOf("fr")>=0?"Supprimer la sÃ©lection":"Clear selection",t.id="ggo-clear-selection",t.setAttribute("style","position:fixed;bottom:0px;left:0px;display:block"),t.addEventListener("click",(()=>{this.selectionManager.clear(),this.hideClearSelectionButton()})),e.appendChild(t)}}hideClearSelectionButton(){const e=document.getElementById("ggo-clear-selection");e&&e.remove()}showWelcomePage(e,t="missingApiKey"){const s=`https://api.galigeo.com/services/powerbi_2_0?action=${t}`;for(console.log("Show welcome page",s);e.lastElementChild;)e.removeChild(e.lastElementChild);const i=document.createElement("iframe");i.id="galigeoWelcome",i.style.height="100%",i.style.width="100%",i.style.border="none",i.src=s,e.appendChild(i)}getFormattingModel(){return this.formattingSettingsService.buildFormattingModel(this.formattingSettings)}}},901:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapParameters=t.Style=t.Listener=t.Messenger=t.Extent=t.Layer=t.Map=void 0;const i=s(407);t.Map=i.default;const o=s(604);t.Layer=o.default;const a=s(617);t.Extent=a.default;const n=s(390);t.Messenger=n.default;const r=s(25);t.Listener=r.default;const l=s(716);Object.defineProperty(t,"Style",{enumerable:!0,get:function(){return l.Style}}),Object.defineProperty(t,"MapParameters",{enumerable:!0,get:function(){return l.MapParameters}})},903:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Duplicate=void 0,t.Duplicate=class{onDuplicateMap=!1;element;constructor(e){this.element=e}createDuplicateModal(e,t){return new Promise(((t,s)=>{this.onDuplicateMap=!0,document.getElementById("ggo-modal")&&document.getElementById("ggo-modal").remove();const i=document.createElement("div");i.id="ggo-modal",i.className="ggo-modal",i.style.position="fixed",i.style.zIndex="1",i.style.paddingTop="50px",i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%",i.style.overflow="auto",i.style.backgroundColor="rgba(0,0,0,0.4)",i.style.display="block";const o=document.createElement("div");o.id="ggo-modal-content",o.className="ggo-modal-content",o.style.backgroundColor="#fefefe",o.style.margin="auto",o.style.padding="20px",o.style.border="1px solid #888",o.style.width="80%",o.style.height="80%",o.style.overflow="auto",o.style.position="relative",o.style.display="block",o.style.borderRadius="10px";const a=document.createElement("h2");a.innerText="Duplicate map",o.appendChild(a);const n=document.createElement("p");n.innerText="A change has been detected in the map ID. You can duplicate the map to keep the current configuration.";const r=document.createElement("input");r.type="text",r.value=e.mapId,r.style.width="100%",r.style.padding="10px",r.style.margin="10px 0",r.style.border="1px solid #ccc",r.style.boxSizing="border-box";const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="row",l.style.width="100%";const c=document.createElement("button");c.innerText="Duplicate",c.style.padding="10px",c.style.margin="10px 0",c.style.border="1px solid #ccc",c.style.width="100px",c.style.backgroundColor="#4CAF50",c.style.color="white";const d=document.createElement("button");d.innerText="Cancel",d.style.padding="10px",d.style.margin="10px 0",d.style.border="1px solid #ccc",d.style.width="100px",d.addEventListener("click",(()=>{i.remove(),t(null),this.onDuplicateMap=!1})),c.addEventListener("click",(()=>{const s=new XMLHttpRequest,o=document.getElementById("galigeoMap");s.open("GET",new URLSearchParams(o.src).get("url")+"/duplicate?name="+e.mapId,!1),console.log("loaded"),s.send(null),console.log("sent"),console.log("New map ID: "+JSON.parse(s.response).docId),e.mapId=JSON.parse(s.response).docId,t(JSON.parse(s.response).docId),i.remove(),this.onDuplicateMap=!1})),o.appendChild(n),o.appendChild(r),l.appendChild(c),l.appendChild(d),o.appendChild(l),i.appendChild(o),this.element.appendChild(i)}))}}},938:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Security=void 0,t.Security=class{static async authenticate(e,t){return new Promise(((s,i)=>{e.acquireAADTokenService.acquireAADTokenstatus().then((o=>{0===o?e.acquireAADTokenService.acquireAADToken().then((async e=>{if(console.log("access token",e),e.accessToken){const i=this.parseJwt(e.accessToken);s({user:i.preferred_username,displayName:i.name,authenticated:!0,editMode:1===t.viewMode})}else i(new Error("No access token"))})):s({editMode:1===t.viewMode,authenticated:!1})}))}))}static parseJwt(e){const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(window.atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(s)}}},954:(e,t,s)=>{"use strict";s.r(t)},959:e=>{e.exports={visual:{name:"GaligeoPowerBI",displayName:"Galigeo for PowerBI (2.1.0.3)",guid:"GaligeoPowerBI",visualClassName:"Visual",version:"2.1.0.3",description:"Galigeo for PowerBI",supportUrl:"https://galigeo.com",gitHubUrl:"https://github.com/Galigeo/Galigeo-for-PowerBI"},apiVersion:"5.11.0",author:{name:"Galigeo",email:"contact@galigeo.com"},assets:{icon:"assets/icon.png"},externalJS:null,style:"style/visual.less",capabilities:"capabilities.json",dependencies:null,stringResources:[]}}},t={};function s(i){var o=t[i];if(void 0!==o)return o.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";var e=i;Object.defineProperty(e,"__esModule",{value:!0});const t=s(848);var o=window.powerbi,a={name:"GaligeoPowerBI",displayName:"Galigeo for PowerBI (2.1.0.3)",class:"Visual",apiVersion:"5.11.0",create:e=>{if(t.Visual)return new t.Visual(e);throw"Visual instance not found"},createModalDialog:(e,t,s)=>{const i=globalThis.dialogRegistry;e in i&&new i[e](t,s)},custom:!0};void 0!==o&&(o.visuals=o.visuals||{},o.visuals.plugins=o.visuals.plugins||{},o.visuals.plugins.GaligeoPowerBI=a),e.default=a})(),GaligeoPowerBI=i})();