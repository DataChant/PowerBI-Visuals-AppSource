var GaligeoPowerBI;(()=>{"use strict";var e={664:(e,t,s)=>{s.d(t,{Z:()=>i});const i=class{constructor(e,t,s,i){this.xmin=e,this.ymin=t,this.xmax=s,this.ymax=i}}},826:(e,t,s)=>{s.d(t,{D5:()=>i.Z,QC:()=>o.QC});var i=s(915),o=(s(365),s(543))},741:(e,t,s)=>{s.d(t,{Z:()=>r});var i=s(787);class o extends i.Z{constructor(e,t){super(),this.id=e,this.name=t.name?t.name:e,this.datasourceId=t.datasourceId,this.datasetId=t.datasetId,this.visible=t.visible,this.isApiLayer=t.isApiLayer,this.messenger=t.messenger,this.messenger&&this.registerEvents()}getId(){return this.id}getName(){return this.name}getDatasetId(){return this.datasetId}isIssuedFromAPIData(){return this.datasourceId&&"CE"===this.datasourceId}getDatasourceId(){return this.datasourceId}setVisible(e){return this.messenger.postMessage("setVisible",e,this)}disableInfoWindow(){return this.messenger.postMessage("disableInfoWindow","",this)}filter(e){return this.messenger.postMessage("filter",e,this)}registerEvents(){this.messenger.addEventListener("layer",(e=>{e.layer&&e.layer.id===this.id&&this.fireEvent(e.action,e.value)}))}}const r=o},787:(e,t,s)=>{s.d(t,{Z:()=>i});const i=class{constructor(){this._listeners=new Map,this._messages=[]}addEventListener(e,t){let s=this._listeners.get(e);s||(s=[],this._listeners.set(e,s)),s.push(t)}removeEventListner(e,t){let s=this._listeners.get(e);return!!s&&(s=s.filter((e=>e!==t)),!0)}fireEvent(e,t){let s=this._listeners.get(e);if(s)for(let e of s)e(t)}}},915:(e,t,s)=>{s.d(t,{Z:()=>d});var i=s(664),o=s(741),r=s(365),n=s(787),a=s(738);class l extends n.Z{constructor(e,t){super(),this.loaded=!1,console.log("Welcome to Galigeo"),this.options=t,this.element="string"==typeof e?document.getElementById(e):e,t.lang||(t.lang=navigator.language.split("-")[0]),t.url||(t.url="https://showroom.galigeo.com/Galigeo"),t.id&&!t.mapId&&(t.mapId=t.id),t.name&&!t.mapId&&(t.mapId=t.name.toUpperCase().toLowerCase().replace(/[^a-z0-9]/gi,"")),this.options.url.endsWith("/")&&(this.options.url=this.options.url.slice(0,-1)),this.options.data||(this.options.data=[]);for(let e of this.options.data)e.url&&(e.url=this.fixRelativeUrl(e.url));return this}load(){return e=this,t=void 0,i=function*(){return console.log("Loading Map"),new Promise(((e,t)=>{fetch(this.options.url+"/api/openMap/encoded",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},mode:"cors",body:`status=200&lang=${navigator.language}&data=${encodeURIComponent(JSON.stringify(this.options))}`}).then((e=>e.json())).then((t=>{t.message?this.showError(t.message,null):(this.iframe=this.createIframe(this.element,t),this.messenger=new r.Z(this.iframe,this.options.timeout),this.refreshId=t.refreshId,this.registerEvents(),console.log("API- after fetch json",t),this.messenger.waitMapIsLoad().then((s=>{console.log("API- Map loaded",t),this.loaded=!0,this.setMapControlsVisible(!1),e(this)})))})).catch((e=>{this.showError("Unable to access Galigeo",e),t(e)}))}))},new((s=void 0)||(s=Promise))((function(o,r){function n(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}));var e,t,s,i}update(e){if(!this.refreshId||!this.loaded)throw new Error("Data update not available");return new Promise(((t,s)=>{fetch(this.options.url+"/api/openMap/encoded?refreshId="+this.refreshId,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:`status=200&lang=${navigator.language}&data=${encodeURIComponent(JSON.stringify(e))}`}).then((e=>e.json().then((e=>{e.message?s(e):t(e)})))).catch((e=>{this.showError("Unable to update data",e),s(e)}))}))}showError(e,t){console.error("Failed to load map",e,t);const s=this.element;for(;s.firstChild;)s.removeChild(s.firstChild);s.insertAdjacentHTML("beforeend",`<div id="galigeoError" style="height:100%;\n               text-align: center;\n               padding: 30px;\n               background-image: linear-gradient(135deg, #2ecc71 0%, #27a0ad 100%) !important; \n               color:white;\n               font-size: x-large;">\n            <h4>Unable to access Galigeo from ${this.options.url}</h4> \n            <p>${e}</p>\n            <p>${t?t.toLocaleString():""}</p></div>`)}isLoaded(){return this.loaded}refresh(){return this.messenger.postMessage("refresh",{})}setExtent(e){return this.messenger.postMessage("setExtent",e)}flyTo(e,t,s){return this.messenger.postMessage("flyTo",{x:e,y:t,zoom:s})}zoomTo(e,t,s){return this.messenger.postMessage("zoomTo",{x:e,y:t,zoom:s})}print(e,t,s){return new Promise(((i,o)=>{this.messenger.postMessage("print",{withLegend:e,savePng:t,title:s}).then((e=>{i(e)}))}))}enableMapNavigation(){return this.messenger.postMessage("enableMapNavigation",{})}disableMapNavigation(){return this.messenger.postMessage("disableMapNavigation",{})}setMenuVisible(e){return this.messenger.postMessage("setMenuVisible",e)}setMapControlsVisible(e){return this.messenger.postMessage("setMapControlsVisible",e)}setOpenNewTabVisible(e){return this.messenger.postMessage("setOpenNewTabVisible",e)}setBasemap(e){return this.messenger.postMessage("setBasemap",e)}addDataUrl(e,t){if(this.isLoaded())throw new Error("Cannot add new data once the map is loaded");this.options.data.push({format:"link",url:this.fixRelativeUrl(e),name:t})}createGeojsonFeatures(e,t){return new Promise(((s,i)=>{this.messenger.postMessage("createGeojsonFeatures",{features:e,style:t}).then((e=>{const t=new o.Z(e.layer_id,{name:e.layer_id,isApiLayer:!0,datasetId:void 0,datasourceId:void 0,visible:!0,messenger:this.messenger});s(t)}))}))}addMarker(e,t,s,i){return new Promise(((r,n)=>{this.messenger.postMessage("addMarker",{coordinates:e,style:t,iconSvgOptions:s,urlSvg:i}).then((e=>{const t=new o.Z(e.layer_id,{name:e.layer_id,isApiLayer:!0,datasetId:void 0,datasourceId:void 0,visible:!0,messenger:this.messenger});r(t)}))}))}removeLayer(e){return new Promise(((t,s)=>{this.messenger.postMessage("removeLayer",{layer:e}).then((e=>{t(e)}))}))}getLayers(){return new Promise(((e,t)=>{this.messenger.postMessage("getLayers",null).then((t=>{const s=[];for(const e of t){const t=new o.Z(e.id,{name:e.name,datasetId:e.datasetId,datasourceId:e.datasourceId,visible:e.visible,messenger:this.messenger});s.push(t)}e(s)}))}))}registerEvents(){this.messenger.addEventListener("map",(e=>{let t;t="zoomend"===e.action?new i.Z(e.value.minX,e.value.minY,e.value.maxX,e.value.maxY):e.value,this.fireEvent(e.action,t)}))}createIframe(e,t){const s=e,i=this.options.devMode?"indexdev.jsp":"index.html",o=document.getElementById("galigeoError");o&&o.remove();let r="listenMessages=true";this.options.crossDomain&&(r+="&crossDomain=true"),this.options.parent&&(r+="&parent="+this.options.parent),this.options.lang&&(r+="&lang="+this.options.lang);const n=this.options.url+"/"+t.relativeUrlServiceUrl;let l=`${this.options.url}/viewer/${i}?${r}&url=${n}&lang=${navigator.language.split("-")[0]}`;if(t.sso&&this.options.oauth2Enabled&&(l=`${this.options.url}/oauth/login.html?orgId=${t.orgId}&service=${t.service}&redirect=${encodeURIComponent(l)}`,this.options.oauth2Popup&&(l+="&popup=true"),console.log("sso",l)),this.options.redirect)return a.location.href=l,null;let d=e.querySelector("#galigeoMap");return d?d.src=l:(d=document.createElement("iframe"),d.src=l,d.width="100%",d.height="100%",d.title="Galigeo Map",d.id="galigeoMap",d.setAttribute("style","border: 0px"),d.addEventListener("error",(function(e){console.log("Failed to load iframe : ",e)})),"iPhone"!==navigator.platform&&"iPad"!==navigator.platform||setTimeout((()=>{try{""===d.contentWindow.document.querySelector("body").innerHTML&&(d.focus(),d.src=l)}catch(e){console.log("Failed to load iframe : ",e)}}),2e3),s.appendChild(d)),d}fixRelativeUrl(e){if(0!==e.toLowerCase().indexOf("http")){var t=a.location.href.lastIndexOf("/");return a.location.href.substring(0,t+1)+e}return e}}const d=l},365:(e,t,s)=>{s.d(t,{Z:()=>a});var i=s(787),o=s(543),r=s(738);class n extends i.Z{constructor(e,t=3e4){super(),this.ready=!1,this.responses=new Map,this.idCounter=1,this.iframe=e,this.timeout=t,this.registerEvents()}registerEvents(){const e=this.iframe;console.log("API - Listen for messages",e.contentWindow),r.addEventListener("message",(t=>{if(t.source!==e.contentWindow)return;if("GaligeoMapLoaded"===t.data)return;const s=new o.v0(t.data);if("response"===s.type){console.log("API- receive response",s);const e=this.responses.get(s.id);e?(console.log("API- resolve response",e),this.responses.delete(s.id),e.resolve(s.value)):console.warn("API- Missing response handler for message ",s)}"event"===s.type&&this.fireEvent(s.source,s)}))}waitMapIsLoad(){return new Promise(((e,t)=>{r.addEventListener("message",(t=>{"GaligeoMapLoaded"===t.data&&(this.ready=!0,e("map loaded"))})),setTimeout((()=>{this.ready||t("Timeout excedeed, failed to load map")}),this.timeout)}))}postMessage(e,t,s){return new Promise(((i,r)=>{const n=new o.v0;if(n.source="api",n.type="function",n.action=e,n.value=t,n.id=""+this.idCounter++,n.layer=s,!this.ready)throw new Error("Map not ready, unable to send messages");{console.log("API- action =",e,n);const t=new o.v0;if(t.resolve=i,this.responses.set(n.id,t),!this.iframe||!this.iframe.contentWindow)throw new Error("Map iframe not ready, unable to send message "+e);this.iframe.contentWindow.postMessage(JSON.stringify(n),"*")}}))}}const a=n},543:(e,t,s)=>{s.d(t,{QC:()=>o,v0:()=>r});var i=s(741);class o{}class r{constructor(e){if(e)try{const t=JSON.parse(e);this.id=t.id,this.source=t.source,this.type=t.type,this.action=t.action,this.value=t.value,t.layer&&(this.layer=new i.Z(t.layer.id,{name:t.layer.name}))}catch(t){console.debug("Skip message",e,t)}}}},563:(e,t,s)=>{s.d(t,{Z:()=>i});class i{constructor(e){var t,s,i,o;this.id=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"data",this.name=null!==(s=null==e?void 0:e.name)&&void 0!==s?s:"PowerBI Data",this.fields=null!==(i=null==e?void 0:e.fields)&&void 0!==i?i:[],this.features=null!==(o=null==e?void 0:e.features)&&void 0!==o?o:[]}}},685:(e,t,s)=>{s.d(t,{Z:()=>i});class i{static getDataset(e){const t=e.categorical;if(!t)return null;const s={id:"data",name:"PowerBI Data",fields:[],features:[]},o={};t.categories&&i.parseCategory(s,o,t.categories,!0),t.values&&i.parseCategory(s,o,t.values,!1);const r={};for(let e in s.fields){const t=this.getFieldName(s.fields[e].name),i=o[t];for(let e=0;e<i.length;e++)r[e]||(r[e]={}),r[e][t]=i[e]}for(let e in r)s.features.push({attributes:r[e]});return console.log("Nb features",s.features.length),s}static isSameDataset(e,t){if(void 0===e||void 0===t)return!1;if(void 0===e.features||void 0===t.features)return!1;if(void 0===e.fields||void 0===t.fields)return!1;if(e.features.length!==t.features.length)return!1;if(e.fields.length!==t.fields.length)return!1;for(let s=0;s<e.features.length;s++){const i=e.features[s],o=t.features[s];for(let e in i.attributes)if(i.attributes[e]!==o.attributes[e])return!1}return!0}static parseCategory(e,t,s,o){if(s)for(let r=0;r<s.length;r++)try{const n=s[r],a=i.getFieldName(n.source.displayName);t[a]=n.values,e.fields.push({name:a,alias:a,alias2:a,type:this.getFieldType(n.source.type),geodim:o})}catch(e){console.error(r,s,e)}}static getFieldName(e){return e.startsWith("Moyenne de ")?e.substring(11):e.startsWith("Somme de ")?e.substring(9):e.startsWith("Sum of ")?e.substring(7):e.startsWith("Average of ")?e.substring(11):e}static getFieldType(e){return e.numeric?"esriFieldTypeDouble":e.integer?"esriFieldTypeInteger":e.bool?"esriFieldTypeBoolean":"esriFieldTypeString"}static hasSameKeys(e,t){return!(!e||!t)&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every((e=>t.hasOwnProperty(e)))}static getFieldKeys(e){const t={};if(void 0===e)return t;for(let s=0;s<e.length;s++)t[e[s].name]=!0;return t}}},561:(e,t,s)=>{s.d(t,{J:()=>o});var i=s(554).U;class o extends i{constructor(){super(...arguments),this.galigeo=new r}}class r{constructor(){this.url="https://powerbi.galigeo.com/Galigeo",this.apiKey="to be completed",this.mapId="",this.highlight=!0,this.infowindow=!0}}},889:(e,t,s)=>{s.d(t,{u:()=>a});var i=s(561),o=s(826),r=s(685),n=s(563);class a{constructor(e){this.dataPoints={},this.listenersRegistered=!1,this.previousSettings={},this.previoudFieldsMap={},this.previousState="",console.log("Visual constructor",e),this.visualConstructorOptions=e,this.element=e.element,this.showWelcomePage(e.element),this.selectionManager=this.visualConstructorOptions.host.createSelectionManager(),this.selectionManager.clear()}update(e){var t,s,i,l,d,h,g,c;return d=this,h=void 0,c=function*(){this.settings=a.parseSettings(e&&e.dataViews&&e.dataViews[0]),console.log("Visual update",e,this.settings,this.settings.galigeo.mapId);const d=new Array;for(let t=0;t<e.dataViews.length;t++){const s=e.dataViews[t];d.push(r.Z.getDataset(s))}if("to be completed"===this.settings.galigeo.apiKey||this.settings.galigeo.apiKey.length<3){if("missingApiKey"===this.previousState)return;return this.previousState="missingApiKey",void this.showWelcomePage(this.element,"missingApiKey")}if(!this.settings.galigeo.mapId||this.settings.galigeo.mapId.length<3){if("missingMapId"===this.previousState)return;return this.previousState="missingMapId",void this.showWelcomePage(this.element,"missingMapId")}const h=void 0!==this.previousOpenMapData&&r.Z.isSameDataset(d[0],new n.Z(null===(t=this.previousOpenMapData)||void 0===t?void 0:t.data)),g=new o.QC;g.name=this.settings.galigeo.mapId,g.mapId=g.name.replace(/[^a-z0-9]/gi,""),g.user=e.viewMode?"Creator":"Viewer",g.profile=e.viewMode?"Designer":"Viewer",g.lang=navigator.language,g.data=d,g.apiKey=this.settings.galigeo.apiKey,g.url=this.settings.galigeo.url,g.crossDomain=!0,g.parent="PowerBI";let c=void 0!==this.previousOpenMapData&&(this.previousOpenMapData.mapId!==g.mapId||this.previousOpenMapData.apiKey!==g.apiKey||this.previousOpenMapData.profile!==g.profile||this.previousOpenMapData.url!==g.url||this.settings.galigeo.highlight!==(null===(s=this.previousSettings)||void 0===s?void 0:s.highlight)||this.settings.galigeo.infowindow!==(null===(i=this.previousSettings)||void 0===i?void 0:i.infowindow)||"ok"!==this.previousState);if(h&&!c)return void console.info("No change detected, abort");this.previousState="ok",r.Z.hasSameKeys(this.previoudFieldsMap,r.Z.getFieldKeys(d[0].fields))||(console.log("Change in fields map"),c=!0),this.previousOpenMapData=g,this.previousSettings.highlight=this.settings.galigeo.highlight,this.previousSettings.infowindow=this.settings.galigeo.infowindow,this.previoudFieldsMap=r.Z.getFieldKeys(d[0].fields);const u=document.getElementById("galigeoWelcome");u&&(u.style.display="none"),(null===(l=this.map)||void 0===l?void 0:l.refreshId)&&!c?this.map.update(g).then((()=>{this.registerMap2Report(e),this.map.refresh()})):(this.map=new o.D5(this.element.id,g),this.map.load().then((()=>{this.listenersRegistered=!1,this.registerMap2Report(e)})))},new((g=void 0)||(g=Promise))((function(e,t){function s(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof g?o:new g((function(e){e(o)}))).then(s,i)}o((c=c.apply(d,h||[])).next())}))}registerMap2Report(e){const t=this.setupFilter(e);this.settings.galigeo.highlight&&!this.listenersRegistered&&(this.listenersRegistered=!0,this.map.addEventListener("contextmenu",(e=>{console.log("Context menu on ",e),this.selectionManager.showContextMenu({},{x:e.x,y:e.y})})),this.listenersRegistered=!0,this.map.getLayers().then((e=>{for(let s of e)s.isIssuedFromAPIData()&&(console.log(`Listen interactions from layer ${s.getName()}`),this.settings.galigeo.infowindow||s.disableInfoWindow(),s.addEventListener("click",(e=>{const s=[],i={};for(let o of Object.keys(e)){const r=e[o];if(!r||!r.properties)return;let n=r.properties[t];if(void 0===n&&(n=r.properties[t.toLowerCase().replace(/\s/g,"")]),n&&!i[n]){const e=this.dataPoints[n];s.push(...e),i[n]=1}}console.log("Click on "+Object.keys(e).length+" entities of "+t+". "+s.length+" objects will be selected."),this.selectionManager.select(s),console.log("Selection done"),this.showClearSelectionButton(this.element)})))})))}static parseSettings(e){return i.J.parse(e)}enumerateObjectInstances(e){return i.J.enumerateObjectInstances(this.settings||i.J.getDefault(),e)}setupFilter(e){var t;if(!e.dataViews||0===e.dataViews.length)return"Error";const s=null===(t=e.dataViews[0])||void 0===t?void 0:t.categorical.categories,i=s[0],o=i.values.length;this.dataPoints={};for(let e=0;e<o;e++){const t=i.values[e],s=this.visualConstructorOptions.host.createSelectionIdBuilder().withCategory(i,e).createSelectionId();let o=this.dataPoints[t+""];o?o.push(s):this.dataPoints[t+""]=[s]}return s[0].source.displayName}showClearSelectionButton(e){const t=document.getElementById("ggo-clear-selection");if(t)t.style.display="block";else{const t=document.createElement("button");t.value="clear",t.innerText=navigator.language.indexOf("fr")>=0?"Supprimer la sÃ©lection":"Clear selection",t.id="ggo-clear-selection",t.setAttribute("style","position:fixed;bottom:0px;left:0px;display:block"),t.addEventListener("click",(()=>{this.selectionManager.clear(),this.hideClearSelectionButton()})),e.appendChild(t)}}hideClearSelectionButton(){const e=document.getElementById("ggo-clear-selection");e&&e.remove()}showWelcomePage(e,t="missingApiKey"){const s=`https://api.galigeo.com/services/powerbi?action=${t}`;for(console.log("Show welcome page",s);e.lastElementChild;)e.removeChild(e.lastElementChild);e.insertAdjacentHTML("beforeend",`<iframe id="galigeoWelcome" style="height: 100%;width:100%;border:none" src="${s}">`)}}},567:(e,t,s)=>{function i(e,t,s){if(!e)return s;let i=e[t];return void 0===i?s:i}s.d(t,{N:()=>i})},982:(e,t,s)=>{s.d(t,{d9:()=>o});var i=s(567);function o(e,t,s){const o=function(e,t,s){return e?i.N(e[t.objectName],t.propertyName,s):s}(e,t,s);return o&&o.solid?o.solid.color:null==o||"object"==typeof o&&!o.solid?s:o}},554:(e,t,s)=>{s.d(t,{U:()=>o});var i=s(982);class o{static getDefault(){return new this}static createPropertyIdentifier(e,t){return{objectName:e,propertyName:t}}static parse(e){let t,s=this.getDefault();if(!e||!e.metadata||!e.metadata.objects)return s;t=s.getProperties();for(let o in t)for(let r in t[o]){const n=s[o][r];s[o][r]=i.d9(e.metadata.objects,t[o][r],n)}return s}static isPropertyEnumerable(e){return!o.InnumerablePropertyPrefix.test(e)}static enumerateObjectInstances(e,t){let s=e&&e[t.objectName];if(!s)return[];let i={objectName:t.objectName,selector:null,properties:{}};for(let e in s)s.hasOwnProperty(e)&&(i.properties[e]=s[e]);return{instances:[i]}}getProperties(){let e={};return Object.keys(this).forEach((t=>{if(o.isPropertyEnumerable(t)){let s=Object.keys(this[t]);e[t]={},s.forEach((s=>{o.isPropertyEnumerable(t)&&(e[t][s]=o.createPropertyIdentifier(t,s))}))}})),e}}o.InnumerablePropertyPrefix=/^_/},738:e=>{e.exports=Function("return this")()}},t={};function s(i){var o=t[i];if(void 0!==o)return o.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,s),r.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{s.r(i),s.d(i,{default:()=>r});var e=s(889),t=s(738).powerbi,o={name:"GaligeoPowerBI",displayName:"Galigeo for PowerBI (1.0.8.6)",class:"Visual",apiVersion:"3.8.0",create:t=>{if(e.u)return new e.u(t);throw"Visual instance not found"},createModalDialog:(e,t,s)=>{const i=globalThis.dialogRegistry;e in i&&new i[e](t,s)},custom:!0};void 0!==t&&(t.visuals=t.visuals||{},t.visuals.plugins=t.visuals.plugins||{},t.visuals.plugins.GaligeoPowerBI=o);const r=o})(),GaligeoPowerBI=i})();