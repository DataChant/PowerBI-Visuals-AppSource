var ifcviewer;(()=>{"use strict";var e={820:(e,t,i)=>{i.d(t,{b:()=>a});var n=i(674),s=i(327),o=function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function l(e){try{r(n.next(e))}catch(e){o(e)}}function a(e){try{r(n.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(l,a)}r((n=n.apply(e,t||[])).next())}))};let l=null;class a{constructor(e){this.ifcViewerModule=null,this.selectionIdMap=new Map,this.hasServicePlans=!1,this.isDesktop=!1,this.isLicenseUnsupportedEnv=!1,this.isLicenseInfoAvailable=!1,this.isNotificationDisplayed=!1,this.defaultNotificationType=0,this.target=e.element,this.host=e.host,this.updateCount=0,this.formattingSettingsService=new n.O,this.selectionManager=this.host.createSelectionManager(),this.host.licenseManager?(this.licenseManager=this.host.licenseManager,this.initializeLicensing()):console.warn("License management is not supported in this environment.");const t=document.createElement("bim-grid");t.setAttribute("id","ifc-viewer"),this.target.appendChild(t),this.handleContextMenu(),t&&t.addEventListener("ifcSelectionEvent",(e=>{var t;const i=null===(t=null==e?void 0:e.detail)||void 0===t?void 0:t.selectedValue;if(!i||!Array.isArray(i))return;const n=[];for(const e of i)if(e.children&&Array.isArray(e.children))for(const t of e.children)if(t.data&&"Attributes"===t.data.Name&&t.children&&Array.isArray(t.children))for(const e of t.children)e.data&&"GlobalId"===e.data.Name&&n.push(e.data.Value);const s=[];n.forEach((e=>{const t=this.selectionIdMap.get(e);if(t)s.push(t);else{const t=function(e){const t=(new TextEncoder).encode(e);return Array.from(t).map((e=>e.toString().padStart(3,"0"))).join("")}(e),i=this.selectionIdMap.get(t);i&&s.push(i)}})),0===s.length?this.selectionManager.clear():this.selectionManager.select(s,!1)})),this.loadIfcViewerModule()}initializeLicensing(){var e;return o(this,void 0,void 0,(function*(){if(this.isDesktop=4===this.host.hostEnv,!this.isDesktop&&this.licenseManager)try{const{plans:t,isLicenseUnsupportedEnv:i,isLicenseInfoAvailable:n}=yield this.licenseManager.getAvailableServicePlans();if(console.log(yield this.licenseManager.getAvailableServicePlans()),this.isLicenseInfoAvailable=n,this.isLicenseUnsupportedEnv=i,n&&!i&&(this.currentUserValidPlans=null==t?void 0:t.filter((e=>1===e.state||2===e.state)),this.hasServicePlans=!!(null===(e=this.currentUserValidPlans)||void 0===e?void 0:e.length)),!this.hasServicePlans){const e=this.isLicenseUnsupportedEnv?1:this.defaultNotificationType;this.licenseManager.notifyLicenseRequired(e).then((e=>{this.isNotificationDisplayed=e})).catch((e=>{console.error("License notification error:",e)}))}}catch(e){console.error("Error retrieving license info:",e)}}))}handleContextMenu(){this.target.addEventListener("contextmenu",(e=>{this.selectionManager.showContextMenu({},{x:e.clientX,y:e.clientY}),e.preventDefault()}))}loadIfcViewerModule(){return o(this,void 0,void 0,(function*(){try{yield this.loadStylesheet("https://viewer.flinker.app/assets/index.css"),this.ifcViewerModule=yield import("https://viewer.flinker.app/lib/ifc-viewer.es.js"),this.ifcViewerModule.initializeViewer&&(yield this.ifcViewerModule.initializeViewer(this.target))}catch(e){console.error("Failed to load the IFC Viewer module:",e)}}))}loadStylesheet(e){return new Promise(((t,i)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,n.onload=()=>t(),n.onerror=()=>i(new Error(`Failed to load stylesheet: ${e}`)),document.head.appendChild(n)}))}update(e){if(!this.isDesktop&&!this.isLicenseUnsupportedEnv&&this.licenseManager&&this.isLicenseInfoAvailable&&!this.hasServicePlans)return void this.licenseManager.notifyLicenseRequired(2).then((e=>console.log("Visual is blocked due to missing licenses:",e))).catch((e=>console.error("License notification error:",e)));this.showMessage(null);const t=e.dataViews&&e.dataViews[0];this.loadIfcFiles(t);const i=t.categorical.categories[1],n=i.values.filter((e=>null!==e));this.selectionIdMap.clear();for(let e=0;e<n.length;e++){const t=n[e],s=this.host.createSelectionIdBuilder().withCategory(i,e).createSelectionId();this.selectionIdMap.set(t,s)}if(t.metadata&&t.metadata.isDataFilterApplied){const e=n.map(r);this.ifcViewerModule&&n.length>0&&s.dispatchEvent(new CustomEvent("ifcSelectionEvent",{detail:e}))}else console.log("Data filter not applied. Clearing selection."),s.dispatchEvent(new CustomEvent("ifcSelectionEvent",{detail:null}))}loadIfcFiles(e){var t,i,n,a;return o(this,void 0,void 0,(function*(){const o=null!==(a=null===(n=null===(i=null===(t=null==e?void 0:e.categorical)||void 0===t?void 0:t.categories)||void 0===i?void 0:i.find((e=>{var t;return null===(t=e.source.roles)||void 0===t?void 0:t.IfcChunks})))||void 0===n?void 0:n.values.filter((e=>null!==e)))&&void 0!==a?a:null,r=(o&&o.length,l&&l.length>0);if(!o)return r&&(console.log("Clear IFC files!"),l=null,this.ifcViewerModule.clearModels(),yield this.ifcViewerModule.initializeViewer(this.target)),void this.showMessage("Select or drag fields to IFC Chunks to populate visual!");const c=e.metadata.isDataFilterApplied,d=r&&!c&&o.length!==l.length;if(!r&&c)this.showMessage("Remove the data filter for initial IFC file loading!");else{if(r&&!d)return void console.log("IFC files already loaded!");if(c||(l=o),d&&(console.log("Clear and load new IFC files!"),this.ifcViewerModule.clearModels(),yield this.ifcViewerModule.initializeViewer(this.target)),o.length>0){const e=this.prepareIfcData(o);setTimeout((()=>{this.ifcViewerModule&&(console.log("Load IFC files!"),s.dispatchEvent(new CustomEvent("ifcLoadEvent",{detail:{name:"openModel",payload:{name:null,buffer:e}}})))}),2e3)}else console.log("No IFC files found!")}}))}showMessage(e){let t=document.getElementById("custom-error");e?(t||(t=document.createElement("div"),t.id="custom-error",t.style.position="absolute",t.style.top="0px",t.style.left="50%",t.style.fontSize="small",t.style.transform="translateX(-50%)",t.style.backgroundColor="#ffffff",t.style.color="#000000",t.style.padding="10px",t.style.zIndex="10000000000",this.target.appendChild(t)),t.style.display="block",t.innerHTML=`ðŸ›ˆ ${e} <a href="https://docs.flinker.app/" target="_blank">More info</a>`):t&&(t.style.display="none")}prepareIfcData(e){let t=this.combineIfcChunks(e).replace(/;#/g,";\r\n#");return this.convertIfcTextToUint8Array(t)}combineIfcChunks(e){if(e.length<=1)return e.join("\n");const t=e.map(((e,t)=>{let i=Number.MAX_SAFE_INTEGER;const n=e.match(/#(\d+)=/);return n&&(i=parseInt(n[1],10)),{chunk:e,orderKey:i,originalIndex:t}}));return t.sort(((e,t)=>e.orderKey===t.orderKey?e.originalIndex-t.originalIndex:e.orderKey-t.orderKey)),t.map((e=>e.chunk)).join("")}convertIfcTextToUint8Array(e){return(new TextEncoder).encode(e)}destroy(){var e;(null===(e=this.ifcViewerModule)||void 0===e?void 0:e.destroyViewer)&&this.ifcViewerModule.clear()}}function r(e){if(e.length%3!=0)return e;if(!/^[0-9]+$/.test(e))return e;const t=[];for(let i=0;i<e.length;i+=3){const n=e.substring(i,i+3),s=parseInt(n,10);if(s<0||s>255)return e;t.push(String.fromCharCode(s))}return t.join("")}},754:(e,t,i)=>{i(639)},667:(e,t,i)=>{i.d(t,{A:()=>n});const n=class{constructor(e){this.localizationManager=e}populateFormattingSettingsModel(e,t){var i,n,s;let o=new e,l=null===(n=null===(i=null==t?void 0:t[0])||void 0===i?void 0:i.metadata)||void 0===n?void 0:n.objects;return l&&(null===(s=o.cards)||void 0===s||s.forEach((e=>{var t,i,n;null===(t=null==e?void 0:e.slices)||void 0===t||t.forEach((t=>{null==t||t.setPropertiesValues(l,e.name)})),null===(n=null===(i=null==e?void 0:e.container)||void 0===i?void 0:i.containerItems)||void 0===n||n.forEach((t=>{var i;null===(i=null==t?void 0:t.slices)||void 0===i||i.forEach((t=>{null==t||t.setPropertiesValues(l,e.name)}))}))}))),o}buildFormattingModel(e){var t;let i={cards:[]};return null===(t=e.cards)||void 0===t||t.forEach((e=>{if(!e)return;const t=e.name,n=e.name+"-group";let s={displayName:void 0,slices:[],uid:n},o=e.getFormattingCard(t,s,this.localizationManager);i.cards.push(o);const l={};if(e.container){const i=e.container,a=n+"-container",r={displayName:this.localizationManager&&i.displayNameKey?this.localizationManager.getDisplayName(i.displayNameKey):i.displayName,description:this.localizationManager&&i.descriptionKey?this.localizationManager.getDisplayName(i.descriptionKey):i.description,containerItems:[],uid:a};i.containerItems.forEach((e=>{const i=e.displayNameKey?e.displayNameKey:e.displayName,n=a+i;let s={displayName:this.localizationManager&&e.displayNameKey?this.localizationManager.getDisplayName(e.displayNameKey):e.displayName,slices:[],uid:n};this.buildFormattingSlices(e.slices,t,l,o,s.slices),r.containerItems.push(s)})),s.container=r}e.slices&&this.buildFormattingSlices(e.slices,t,l,o,s.slices),o.revertToDefaultDescriptors=this.getRevertToDefaultDescriptor(e)})),i}buildFormattingSlices(e,t,i,n,s){null==e||e.forEach((e=>{let o=null==e?void 0:e.getFormattingSlice(t,this.localizationManager);o&&(void 0===i[e.name]?i[e.name]=0:(i[e.name]++,o.uid=`${o.uid}-${i[e.name]}`),e.topLevelToggle?(o.suppressDisplayName=!0,n.topLevelToggle=o):s.push(o))}))}getRevertToDefaultDescriptor(e){var t,i;const n={};let s=[],o=this.getSlicesRevertToDefaultDescriptor(e.name,e.slices,n),l=[];return null===(i=null===(t=e.container)||void 0===t?void 0:t.containerItems)||void 0===i||i.forEach((t=>{l=l.concat(this.getSlicesRevertToDefaultDescriptor(e.name,t.slices,n))})),s=o.concat(l),s}getSlicesRevertToDefaultDescriptor(e,t,i){let n=[];return null==t||t.forEach((t=>{t&&!i[t.name]&&(i[t.name]=!0,n=n.concat(t.getRevertToDefaultDescriptor(e)))})),n}}},674:(e,t,i)=>{i.d(t,{O:()=>n.A}),i(754);var n=i(667)},639:(e,t,i)=>{function n(e,t){return{objectName:e,propertyName:t.name,selector:t.selector,altConstantValueSelector:t.altConstantSelector,instanceKind:t.instanceKind}}function s(e,t,i){return null==t||"object"==typeof t&&!t.solid?i:t.solid?{value:null==t?void 0:t.solid.color}:(null==e?void 0:e.items)?e.items.find((e=>e.value==t)):t}i.d(t,{D:()=>s,y:()=>n})},327:e=>{e.exports=Function("return this")()}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{i.r(n),i.d(n,{default:()=>o});var e=i(820),t=i(327).powerbi,s={name:"ifcviewer",displayName:"IFC Viewer",class:"Visual",apiVersion:"5.1.0",create:t=>{if(e.b)return new e.b(t);throw"Visual instance not found"},createModalDialog:(e,t,i)=>{const n=globalThis.dialogRegistry;e in n&&new n[e](t,i)},custom:!0};void 0!==t&&(t.visuals=t.visuals||{},t.visuals.plugins=t.visuals.plugins||{},t.visuals.plugins.ifcviewer=s);const o=s})(),ifcviewer=n})();